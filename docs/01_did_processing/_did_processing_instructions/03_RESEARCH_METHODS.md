# МЕТОДОЛОГІЯ ДОСЛІДЖЕННЯ: DiD + NFC ДЕКОМПОЗИЦІЯ

> **Версія:** 1.0 | **Створено:** 31.01.2026

**Див. також:**
- [01_CURRENT_RESEARCH_CONFIG.md](./01_CURRENT_RESEARCH_CONFIG.md) — параметри поточного дослідження
- [00_WORK_HISTORY.md](./00_WORK_HISTORY.md) — історія робіт

---

## ЗМІСТ

1. [Бізнес-контекст](#1-бізнес-контекст)
2. [Чому Difference-in-Differences](#2-чому-difference-in-differences)
3. [Концепція методології](#3-концепція-методології)
4. [Ключові метрики та формули](#4-ключові-метрики-та-формули)
5. [NFC Compatibility Filter](#5-nfc-compatibility-filter)
6. [Класифікація препаратів](#6-класифікація-препаратів)
7. [Мульти-ринковий підхід](#7-мульти-ринковий-підхід)
8. [Припущення та обмеження](#8-припущення-та-обмеження)
9. [Валідація](#9-валідація)
10. [Технічна реалізація](#10-технічна-реалізація)

---

## 1. БІЗНЕС-КОНТЕКСТ

> **Як відсутність препарату в цільовій аптеці впливає на розподіл попиту покупців?**

Методологія відповідає на питання:
- Яка частка покупців купить **substitute** в нашій аптеці?
- Яка частка піде до **конкурентів**?
- Чи важлива **форма випуску** при виборі substitute?
- Чи є ця поведінка **стабільною across markets**?

**Детальніше:** [01_BUSINESS_CONTEXT.md](../00_ai_rules/01_BUSINESS_CONTEXT.md) — бізнес-задача, глосарій, рекомендації

---

## 2. ЧОМУ DIFFERENCE-IN-DIFFERENCES

### Проблема каузальності

Просте порівняння продажів "до" і "після" stock-out не працює, бо:
- Ринок має власні тренди (сезонність, епідемії)
- Конкуренти змінюють ціни та асортимент
- Неможливо відокремити ефект stock-out від фонових змін

### Альтернативні підходи та їх недоліки

| Підхід | Чому не підходить |
|--------|-------------------|
| **A/B тест** | Неможливо контролювати stock-out — це природне явище |
| **Before-After** | Не враховує фонові тренди ринку |
| **Cross-sectional** | Не враховує індивідуальні особливості препаратів |
| **Регресія** | Потребує багато контрольних змінних, складно інтерпретувати |

### Чому DiD

**Difference-in-Differences** вирішує проблему каузальності через:

1. **Контрольна група** — конкуренти (той самий препарат, але без stock-out)
2. **Подвійна різниця** — віднімаємо зміну в контрольній групі від зміни в treatment

```
DiD Effect = (Treatment_After - Treatment_Before) - (Control_After - Control_Before)
```

**Інтуїція:** Якщо ринок зріс на 10%, а substitute продажі зросли на 25% — реальний ефект stock-out = 15%.

### Адаптація для нашої задачі

Класичний DiD порівнює treatment vs control. Ми адаптували:

| Класичний DiD | Наша адаптація |
|---------------|----------------|
| Treatment = одна група | Treatment = substitute препарати |
| Control = інша група | Control = конкуренти (той самий препарат) |
| Один період | Множинні stock-out події |
| Агрегований ефект | Декомпозиція по NFC формах |
| Одна локація | Множинні ринки (мульти-ринковий підхід) |

---

## 3. КОНЦЕПЦІЯ МЕТОДОЛОГІЇ

### Схема розподілу попиту

```
                     STOCK-OUT ПОДІЯ
                (Препарат X відсутній в нашій аптеці)
                              │
                              ▼
              ┌───────────────────────────────────┐
              │   ПОПИТ НА ПРЕПАРАТ X (100%)      │
              │   (Покупець прийшов за ним)       │
              └───────────────────────────────────┘
                        │             │
                        ▼             ▼
         ┌──────────────────┐  ┌──────────────────┐
         │  SHARE_INTERNAL  │  │   SHARE_LOST     │
         │  (Залишився)     │  │   (Втрачено)     │
         │                  │  │                  │
         │  Купив substitute│  │  Пішов в ІНШУ   │
         │  в НАШІЙ аптеці  │  │  аптеку за X    │
         └──────────────────┘  └──────────────────┘
                  │                     │
                  ▼                     │
         ┌──────────────────┐          │
         │  NFC ДЕКОМПОЗИЦІЯ│          │
         ├──────────────────┤          │
         │ SHARE_SAME_NFC1  │          │
         │ (та сама форма)  │          │
         ├──────────────────┤          ▼
         │ SHARE_DIFF_NFC1  │   ВТРАЧЕНИЙ ДОХІД
         │ (інша форма)     │   (конкуренти заробили)
         └──────────────────┘
```

### Логіка розрахунку

1. **Визначити stock-out події** — періоди з Q=0 після активних продажів
2. **Визначити PRE-період** — базовий рівень продажів до stock-out
3. **Визначити POST-період** — період після відновлення продажів
4. **Розрахувати MARKET_GROWTH** — тренд ринку (контроль)
5. **Розрахувати EXPECTED** — що б продали без stock-out
6. **Розрахувати LIFT** — різниця між фактичними та очікуваними продажами
7. **Агрегувати** — по препаратах, по ринках

### Pipeline фаз

```
PHASE 1: PER-MARKET PROCESSING (для кожного CLIENT_ID)
    Step 1: Агрегація → Step 2: Stock-out → Step 3: DiD → Step 4: Substitutes → Step 5: Звіти
                                                                                    │
                                                                                    ▼
                                                                         Cross-Market CSV
                                                                                    │
                                                                                    ▼
PHASE 2: CROSS-MARKET AGGREGATION
    Агрегація по всіх ринках → Коефіцієнти субституції
```

**Технічна документація:** `docs/01_did_processing/`

---

## 4. КЛЮЧОВІ МЕТРИКИ ТА ФОРМУЛИ

### Базові розрахунки

| Формула | Опис | Призначення |
|---------|------|-------------|
| `MARKET_GROWTH = MARKET_DURING / MARKET_PRE` | Тренд ринку | Контроль фонових змін |
| `EXPECTED = PRE_AVG_Q × MARKET_GROWTH` | Очікувані продажі | Counterfactual |
| `LIFT = max(0, ACTUAL - EXPECTED)` | Додаткові продажі | Ефект stock-out |

### SHARE метрики

| Метрика | Формула | Інтерпретація |
|---------|---------|---------------|
| `INTERNAL_LIFT` | `SUM(LIFT)` всіх substitutes | Скільки попиту перейшло на substitutes |
| `LOST_SALES` | `SUM(COMP_LIFT)` конкурентів | Скільки пішло до конкурентів |
| `TOTAL_EFFECT` | `INTERNAL_LIFT + LOST_SALES` | Загальний перерозподіл |
| `SHARE_INTERNAL` | `INTERNAL_LIFT / TOTAL_EFFECT` | % що залишився у нас |
| `SHARE_LOST` | `LOST_SALES / TOTAL_EFFECT` | % що пішов до конкурентів |

### NFC декомпозиція

| Метрика | Формула | Інтерпретація |
|---------|---------|---------------|
| `LIFT_SAME_NFC1` | `SUM(LIFT)` тієї ж форми | Субституція в межах форми |
| `LIFT_DIFF_NFC1` | `SUM(LIFT)` іншої форми | Субституція між формами |
| `SHARE_SAME_NFC1` | `LIFT_SAME / INTERNAL_LIFT` | Важливість форми випуску |

### Інваріанти (для валідації)

```
SHARE_INTERNAL + SHARE_LOST = 1.0
SHARE_SAME_NFC1 + SHARE_DIFF_NFC1 = 1.0
LIFT_SAME + LIFT_DIFF = INTERNAL_LIFT
```

---

## 5. NFC COMPATIBILITY FILTER

### Проблема

Без фільтру методологія вважала б, що крем може замінити таблетку — це клінічно неможливо та хибно завищує SHARE_INTERNAL.

### Клінічне обґрунтування

Форми випуску мають різні:
- **Шляхи введення** (перорально, парентерально, місцево)
- **Біодоступність** (швидкість та повнота всмоктування)
- **Показання** (системна дія vs локальна)

Покупець, який прийшов за таблетками, НЕ купить крем як заміну.

### Правила сумісності

| Група | Форми | Правило |
|-------|-------|---------|
| **ORAL_GROUP** | Пероральні тверді, рідкі, пролонговані | Взаємозамінні |
| **EXACT_MATCH** | Парентеральні, місцеві, ректальні, офтальмологічні | Тільки на себе |
| **EXCLUDED** | Не для людини | Виключаються |

### Логіка фільтру

```python
def is_compatible(form_A, form_B):
    if form_A in EXCLUDED or form_B in EXCLUDED:
        return False
    if form_A == form_B:
        return True
    if form_A in ORAL_GROUP and form_B in ORAL_GROUP:
        return True
    return False
```

### Вплив на результати

| Аспект | Без фільтру | З фільтром |
|--------|-------------|------------|
| SHARE_INTERNAL | Завищений | Реалістичний |
| CRITICAL препаратів | Менше | Більше |
| Бізнес-рекомендації | Хибні | Коректні |

**Реалізація:** `project_core/did_config/nfc_compatibility.py`

---

## 6. КЛАСИФІКАЦІЯ ПРЕПАРАТІВ

### Логіка класифікації (Per-Market)

```
SHARE_LOST > CRITICAL_THRESHOLD?
      │
  ┌───┴───┐
  ТАК     НІ
  ↓       ↓
CRITICAL  SHARE_INTERNAL > SUBSTITUTABLE_THRESHOLD?
              │
          ┌───┴───┐
          ТАК     НІ
          ↓       ↓
    SUBSTITUTABLE  MIXED
```

### Категорії

| Категорія | Критерій | Рекомендація | Бізнес-значення |
|-----------|----------|--------------|-----------------|
| **CRITICAL** | Високий SHARE_LOST | KEEP | Без цього препарату втрачаємо клієнтів |
| **SUBSTITUTABLE** | Високий SHARE_INTERNAL | CONSIDER_REMOVAL | Клієнти легко переключаються |
| **MIXED** | Інше | REVIEW | Потрібен додатковий аналіз |

**Пороги:** визначені в `project_core/did_config/classification_thresholds.py`

---

## 7. МУЛЬТИ-РИНКОВИЙ ПІДХІД

### Проблема single-market аналізу

Результати для однієї аптеки можуть бути:
- Нестабільними через малу вибірку
- Специфічними для локації
- Впливати на випадкові фактори

### Cross-Market рішення

Агрегація результатів по 50+ ринках дозволяє:
- Отримати статистично значущі коефіцієнти
- Виявити стабільні патерни субституції
- Класифікувати препарати з урахуванням невизначеності

### Cross-Market метрики (Phase 2)

| Метрика | Формула | Інтерпретація |
|---------|---------|---------------|
| `MARKET_COVERAGE` | N_markets_with_drug / N_total | % ринків з препаратом |
| `MEAN_SHARE_INTERNAL` | mean(SHARE_INTERNAL) | Середня субституція |
| `CI_95` | mean ± 1.96 * (std / sqrt(N)) | 95% довірчий інтервал |

### Cross-Market класифікація

```
IF CI_95_UPPER < low_threshold:
    → Навіть в найкращому випадку субституція слабка
    → CRITICAL

ELIF CI_95_LOWER > high_threshold:
    → Навіть в найгіршому випадку субституція сильна
    → SUBSTITUTABLE

ELSE:
    → Невизначеність занадто велика
    → MODERATE
```

**Документація Phase 2:** `docs/02_substitution_coefficients/`

---

## 8. ПРИПУЩЕННЯ ТА ОБМЕЖЕННЯ

### Ключові припущення

| Припущення | Опис | Наслідки порушення |
|------------|------|-------------------|
| **Паралельні тренди** | Без stock-out, target аптека мала б той самий тренд що й ринок | Зміщена оцінка ефекту |
| **Екзогенність stock-out** | Stock-out не залежить від майбутнього попиту | Зміщена каузальність |
| **Стабільність substitutes** | Набір substitutes не змінюється під час stock-out | Неповна картина |
| **NFC сумісність** | Правила сумісності форм коректні | Хибні substitutes |
| **Cross-market consistency** | Поведінка покупців схожа між ринками | Широкі CI |

### Що методологія НЕ враховує

| Фактор | Чому не враховано | Потенційний вплив |
|--------|-------------------|-------------------|
| Цінова еластичність | Немає даних про ціни конкурентів | Може впливати на SHARE_LOST |
| Географія | Агреговано по ринках | Регіональні відмінності |
| Сезонність | Частково через MARKET_GROWTH | Може бути недостатньо |
| Промо-акції | Немає даних | Може спотворювати LIFT |
| Лояльність клієнтів | Немає customer-level даних | Невідомий фактор |

### Обмеження даних

| Обмеження | Опис |
|-----------|------|
| Тижнева гранулярність | Короткі stock-out можуть бути пропущені |
| Агрегований попит | Немає інформації про окремих покупців |
| Історичний період | Результати можуть не відображати поточну ситуацію |

---

## 9. ВАЛІДАЦІЯ

### Інваріанти

Кожен результат повинен відповідати:

```python
# Per-market SHARE сума = 1.0
assert abs(SHARE_INTERNAL + SHARE_LOST - 1.0) < 0.001

# NFC SHARE сума = 1.0
assert abs(SHARE_SAME_NFC1 + SHARE_DIFF_NFC1 - 1.0) < 0.001

# LIFT декомпозиція
assert abs(LIFT_SAME + LIFT_DIFF - INTERNAL_LIFT) < 0.01

# Діапазон [0, 1]
assert 0 <= SHARE_INTERNAL <= 1
assert 0 <= SHARE_LOST <= 1

# Cross-market
assert 0 <= MARKET_COVERAGE <= 1
assert CI_LOWER <= MEAN_SHARE <= CI_UPPER
```

### Edge Cases

| Ситуація | Обробка |
|----------|---------|
| Немає valid substitutes | SHARE_INTERNAL = 0, SHARE_LOST = 1 |
| TOTAL_EFFECT = 0 | SHARE = NaN (подія без ефекту) |
| INTERNAL_LIFT = 0 | SHARE_SAME/DIFF_NFC1 = NaN |
| Негативний LIFT | Обмежуємо до 0: max(0, lift) |
| Low coverage | Широкі CI, класифікація MODERATE |

---

## 10. ТЕХНІЧНА РЕАЛІЗАЦІЯ

### Phase 1: Per-Market Processing

| Крок | Документ |
|------|----------|
| Step 1: Агрегація | [01_DATA_AGREGATION.md](../01_did_processing/01_DATA_AGREGATION.md) |
| Step 2: Stock-out | [02_STOCKOUT_DETECTION.md](../01_did_processing/02_STOCKOUT_DETECTION.md) |
| Step 3: DiD аналіз | [03_DID_NFC_ANALYSIS.md](../01_did_processing/03_DID_NFC_ANALYSIS.md) |
| Step 4: Substitutes | [04_SUBSTITUTE_SHARE_ANALYSIS.md](../01_did_processing/04_SUBSTITUTE_SHARE_ANALYSIS.md) |
| Step 5: Звіти | [05_REPORTS_AND_GRAPHS.md](../01_did_processing/05_REPORTS_AND_GRAPHS.md) |
| Огляд pipeline | [00_PIPELINE_PHASE_1.md](../01_did_processing/00_PIPELINE_PHASE_1.md) |

### Phase 2: Cross-Market Aggregation

**Документація:** `docs/02_substitution_coefficients/` (в розробці)

### Конфігурація

| Тип | Розташування |
|-----|--------------|
| Шляхи до даних | `project_core/data_config/paths_config.py` |
| Пороги, константи | `project_core/did_config/classification_thresholds.py` |
| NFC сумісність | `project_core/did_config/nfc_compatibility.py` |
| DiD функції | `project_core/utility_functions/did_utils.py` |
| ETL функції | `project_core/utility_functions/etl_utils.py` |

---

## ШВИДКА ДОВІДКА

### Основні метрики

| Метрика | Що показує |
|---------|-----------|
| SHARE_INTERNAL | % попиту що залишився у нас |
| SHARE_LOST | % попиту що пішов до конкурентів |
| SHARE_SAME_NFC1 | % substitutes тієї ж форми |
| SUBSTITUTE_SHARE | % конкретного substitute |

### Класифікація

| Категорія | Рекомендація |
|-----------|--------------|
| CRITICAL | KEEP |
| SUBSTITUTABLE | CONSIDER_REMOVAL |
| MIXED / MODERATE | REVIEW |

### NFC фільтр

| Група | Правило |
|-------|---------|
| ORAL_GROUP | Взаємозамінні |
| EXACT_MATCH | Тільки на себе |
| EXCLUDED | Виключаються |

### Інтерпретація та рекомендації

Детальна інтерпретація результатів, глосарій термінів та бізнес-рекомендації:
- [01_BUSINESS_CONTEXT.md](../00_ai_rules/01_BUSINESS_CONTEXT.md)
