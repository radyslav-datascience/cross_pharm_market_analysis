# CLAUDE RULES - cross_pharm_market_analysis

> **Версія:** 1.8 | **Оновлено:** 10.02.2026

---

## ПРОЕКТ

**cross_pharm_market_analysis** — мульти-ринковий аналіз субституції препаратів у фармацевтичних мережах.

**Мета:** DiD-аналіз поведінки покупців при stock-out на 50+ локальних ринках для визначення стабільності субституційних патернів across markets.

**Важливість:** Це проект **корпоративної та продакшен важливості**. Всі розрахунки, формули та алгоритми мають бути перевірені з максимальною ретельністю.

**Ключові метрики:**
- `SHARE_INTERNAL` — частка попиту, що залишилась в аптеці (per market)
- `SHARE_LOST` — частка попиту, що пішла до конкурентів (per market)
- `MARKET_COVERAGE` — % ринків, де присутній препарат
- `CROSS_MARKET_STABILITY` — стабільність субституції across markets (CI, std)

---

## ПРАВИЛА РОБОТИ

### Основний принцип
**АНАЛІЗ → ПЛАН → УЗГОДЖЕННЯ → ВИКОНАННЯ**

Не вносити зміни без підтвердження користувача.

### Принцип глибокого аудиту

**КРИТИЧНО ВАЖЛИВО:** При роботі з цим проектом проводити **ГЛИБОКИЙ АУДИТ**, а не поверхневий.

**Глибокий аудит включає:**
- Порівняння формул **line-by-line** з оригінальною реалізацією
- Перевірка обробки edge cases (нулі, NaN, порожні дані)
- Валідація інваріантів (суми = 100%, логічні обмеження)
- Перевірка порядку операцій та залежностей
- Перевірка назв колонок та структури вихідних даних

**НЕПРИЙНЯТНО:**
- Поверхневий огляд ("виглядає правильно")
- Перевірка тільки назв функцій без аналізу логіки
- Пропуск перевірки edge cases
- Ігнорування невідповідностей "бо вони незначні"

**При виявленні розбіжностей:**
1. Чітко задокументувати проблему
2. Запитати користувача про виправлення
3. Після виправлення — верифікувати результат

### Структура відповіді (перед змінами)
1. **ЩО ЗРОЗУМІВ** — переказ завдання
2. **ЩО БУДУ РОБИТИ** — план дій
3. **ДЕ ВНЕСУ ЗМІНИ** — файли, функції
4. **ЗАПИТ ПІДТВЕРДЖЕННЯ** — "Підтверджуєте?"

### ЗАБОРОНЕНО
- Змінювати документацію в `docs/` без дозволу
- Вносити неузгоджені зміни в код
- Виводити великі блоки коду в термінал

### ДОЗВОЛЕНО без узгодження
- Форматування коду, коментарі, docstrings
- Виправлення очевидних синтаксичних помилок

---

## ПАРАМЕТРИ АНАЛІЗУ

Всі параметри аналізу визначені в:
- **`project_core/data_config/`** — шляхи, ID аптек, INN групи, маппінг колонок
- **`project_core/did_config/`** — пороги класифікації, stock-out detection, NFC сумісність

---

## NFC ЛОГІКА

### Два рівні форм випуску:
- **NFC1_ID** (широкі категорії): Пероральні тверді, Парентеральні, Місцеві, тощо
- **NFC_ID** (специфічні форми): Таблетки, Капсули, Гелі, Ампули, тощо

### NFC Compatibility Filter:
- **ORAL_GROUP** (взаємозамінні між собою):
  - Пероральні тверді звичайні
  - Пероральні тверді пролонговані
  - Пероральні рідкі звичайні
- **EXACT_MATCH** — всі інші форми замінюються тільки на ідентичні

**Реалізація:** `project_core/did_config/nfc_compatibility.py`

---

## СТРУКТУРА ПРОЕКТУ

```
cross_pharm_market_analysis/
├── project_core/                        # Конфігурація та утиліти
│   ├── data_config/                     # Шляхи, ID аптек, INN групи
│   ├── did_config/                      # Phase 1: Пороги, NFC сумісність
│   ├── sub_coef_config/                 # Phase 2: Параметри агрегації
│   └── utility_functions/               # ETL, DiD функції
│
├── data/
│   ├── raw/                             # Вхідні дані (Rd2_{CLIENT_ID}.csv)
│   └── processed_data/
│       ├── 00_preproc_results/          # Phase 0: Preprocessing
│       └── 01_per_market/{CLIENT_ID}/   # Phase 1: Per-market
│           ├── 01_aggregation_{ID}/
│           ├── 02_stockout_{ID}/
│           ├── 03_did_analysis_{ID}/
│           └── 04_substitute_shares_{ID}/
│
├── exec_scripts/                        # Виконувані скрипти
│   ├── 01_did_processing/               # Phase 1 скрипти
│   │   ├── 01_preproc.py
│   │   ├── 02_01_data_aggregation.py
│   │   ├── 02_02_stockout_detection.py
│   │   ├── 02_03_did_analysis.py
│   │   ├── 02_04_substitute_analysis.py
│   │   └── 02_05_reports_cross_market.py
│   └── 02_substitution_coefficients/    # Phase 2 скрипти
│
├── results/
│   ├── data_reports/reports_{ID}/       # Excel звіти per market
│   └── cross_market_data/               # CSV для Phase 2
│
└── docs/
    ├── 00_ai_rules/                     # Правила для AI
    ├── 01_did_processing/               # Phase 1: DiD обробка per-market
    │   └── _did_values_describe/        # Опис колонок та параметрів Phase 1
    ├── 02_substitution_coefficients/    # Phase 2: Крос-ринкові коефіцієнти
    ├── _project_history/                # Історія змін проекту
    └── _temp_project_plan/              # Тимчасові плани (архів)
```

---

## ШЛЯХИ ТА СЕРЕДОВИЩЕ

**Conda environment:** `proxima`

```bash
# Python
/opt/miniconda3/envs/proxima/bin/python

# Виконання скриптів
/opt/miniconda3/envs/proxima/bin/python exec_scripts/{script}.py
```

---

## КЛЮЧОВІ ДОКУМЕНТИ

| Документ | Призначення |
|----------|-------------|
| `docs/00_ai_rules/00_CLAUDE_RULES.md` | Правила роботи з проектом |
| `docs/00_ai_rules/01_BUSINESS_CONTEXT.md` | Бізнес-контекст та метрики |
| `docs/00_ai_rules/02_KNOWN_ISSUES.md` | Відомі проблеми та рішення |
| `docs/00_ai_rules/03_PROJECT_MAP.md` | Структура проекту та pipeline |
| `docs/00_ai_rules/04_DOCUMENTATION_PRINCIPLES.md` | Принципи документування |
| `docs/_project_history/00_WORK_HISTORY.md` | Історія змін проекту |
| `project_core/data_config/` | Конфігурація даних |
| `project_core/did_config/` | Конфігурація дослідження |

---

## ФОРМАТ ВХІДНИХ ДАНИХ

**Файли:** `data/raw/Rd2_{CLIENT_ID}.csv`

**Ключові колонки:**
| Колонка | Опис |
|---------|------|
| `CLIENT_ID` | ID цільової аптеки (= ID з назви файлу) |
| `ORG_ID` | ID аптеки-продавця |
| `DRUGS_ID` | Morion ID препарату |
| `INN_ID` | ID групи діючої речовини |
| `Q` | Кількість проданих упаковок |

**Логіка:**
- `ORG_ID == CLIENT_ID` → продаж цільової аптеки
- `ORG_ID != CLIENT_ID` → продаж конкурента

---

## ПІСЛЯ ЗАВЕРШЕННЯ КРОКУ

Оновити `WORK_HISTORY.md`:
- Що зроблено
- Ключові результати
- Наступний крок
