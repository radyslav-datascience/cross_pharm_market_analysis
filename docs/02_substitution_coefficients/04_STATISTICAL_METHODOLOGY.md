# STATISTICAL METHODOLOGY - Phase 2

> **Версія:** 1.0 | **Створено:** 01.02.2026

---

## 1. ПРИЗНАЧЕННЯ

Цей документ описує статистичні методи для розрахунку загальних коефіцієнтів субститованості across markets.

---

## 2. ПРОБЛЕМА

### Вхідні дані
Для кожного препарату маємо набір значень SHARE_INTERNAL з різних ринків:

```
Препарат X: [0.75, 0.82, 0.68, 0.71, 0.79, 0.65, 0.88, ...]
             ↑ Ринок 1  ↑ Ринок 2  ... (N ринків)
```

### Задача
Визначити **один загальний коефіцієнт** з оцінкою надійності.

---

## 3. МЕТОДИ РОЗРАХУНКУ

### 3.1. Зважене середнє (основний метод)

**Формула:**
```
WEIGHTED_MEAN_SHARE = Σ(SHARE_INTERNAL_i × WEIGHT_i) / Σ(WEIGHT_i)

де WEIGHT_i = INTERNAL_LIFT_i (сума LIFT substitutes на ринку i)
```

**Обґрунтування:**
- Ринки з більшим INTERNAL_LIFT мають більше stock-out подій
- Більше подій → надійніша оцінка SHARE_INTERNAL
- Зважене середнє дає більшу вагу надійнішим оцінкам

**Приклад:**
```
Ринок A: SHARE_INTERNAL = 0.80, INTERNAL_LIFT = 500 упак.
Ринок B: SHARE_INTERNAL = 0.40, INTERNAL_LIFT = 20 упак.

Просте середнє:  (0.80 + 0.40) / 2 = 0.60
Зважене середнє: (0.80×500 + 0.40×20) / (500+20) = 0.785

→ Зважене середнє ближче до Ринку A (більша вага)
```

### 3.2. Просте середнє (для порівняння)

**Формула:**
```
SIMPLE_MEAN_SHARE = Σ(SHARE_INTERNAL_i) / N
```

**Використання:** Зберігається для порівняння з зваженим середнім.

---

## 4. МЕТРИКИ ВАРІАТИВНОСТІ

### 4.1. Стандартне відхилення (STD)

**Формула:**
```
STD_SHARE = √(Σ(SHARE_i - MEAN)² / (N - 1))
```

**Інтерпретація:** Абсолютна міра розкиду значень по ринках.

### 4.2. Коефіцієнт варіації (CV)

**Формула:**
```
CV_PERCENT = (STD_SHARE / MEAN_SHARE) × 100
```

**Інтерпретація:** Відносна міра варіативності (% від середнього).

**Пороги Reliability:**

| CV | Reliability | Інтерпретація |
|----|-------------|---------------|
| < 15% | **HIGH** | Стабільна субституція across markets |
| 15-30% | **MEDIUM** | Помірна варіативність |
| > 30% | **LOW** | Нестабільна — коефіцієнт ненадійний |

**Приклад:**
```
Препарат X: MEAN = 0.72, STD = 0.08 → CV = 11% → HIGH reliability
Препарат Y: MEAN = 0.55, STD = 0.25 → CV = 45% → LOW reliability
```

---

## 5. ДОВІРЧИЙ ІНТЕРВАЛ (CI)

### 5.1. Формула 95% CI

```
CI_95_LOWER = MEAN - 1.96 × (STD / √N)
CI_95_UPPER = MEAN + 1.96 × (STD / √N)
```

**Де:**
- `MEAN` — середнє значення (просте або зважене)
- `STD` — стандартне відхилення
- `N` — кількість ринків з даними
- `1.96` — z-score для 95% рівня довіри

### 5.2. Інтерпретація

```
CI_95 = [0.68, 0.76] означає:
→ З 95% впевненістю "справжній" коефіцієнт субституції
  знаходиться в діапазоні від 68% до 76%
```

### 5.3. Вплив N на ширину CI

```
Формула: CI_width = 2 × 1.96 × (STD / √N)

При STD = 0.10:
- N = 10  → CI_width = 0.124 (±6.2%)
- N = 25  → CI_width = 0.078 (±3.9%)
- N = 50  → CI_width = 0.055 (±2.8%)
- N = 100 → CI_width = 0.039 (±2.0%)

→ Більше ринків = вужчий CI = точніша оцінка
```

---

## 6. КЛАСТЕРИЗАЦІЯ ЗА COVERAGE

### 6.1. Гібридний підхід

**Точне значення:** `COVERAGE_PERCENT` зберігається для детального аналізу.

**Категорія:** `COVERAGE_CLUSTER` для групування.

| Кластер | Coverage | Мін. ринків (при 100) | Статистичне обґрунтування |
|---------|----------|----------------------|---------------------------|
| **HIGH** | ≥ 50% | ≥ 50 | Достатньо для надійних статистичних тестів |
| **MEDIUM** | 20-49% | 20-49 | Мінімум для CLT (Central Limit Theorem) |
| **LOW** | 10-19% | 10-19 | Базова статистика можлива, обмежена надійність |
| **INSUFFICIENT** | < 10% | < 10 | Окремий датасет — недостатньо для висновків |

### 6.2. Обґрунтування порогів

**≥50% (HIGH):**
- CLT працює надійно
- Можливі параметричні тести
- Вузькі CI

**20-49% (MEDIUM):**
- CLT наближення прийнятне при N ≥ 20
- Базові висновки можливі
- Помірні CI

**10-19% (LOW):**
- Мінімум для розрахунку STD та CI
- Широкі CI — обережність у висновках
- Краще використовувати медіану замість середнього

**<10% (INSUFFICIENT):**
- Недостатньо точок для надійної статистики
- Виносяться в окремий датасет

---

## 7. EDGE CASES

### 7.1. N = 1 (один ринок)

```
STD = undefined (ділення на 0)
CI = undefined
CV = undefined

Рішення:
- WEIGHTED_MEAN = SHARE_INTERNAL цього ринку
- STD, CV, CI = NULL
- RELIABILITY = "SINGLE_MARKET"
- Включити в INSUFFICIENT dataset
```

### 7.2. Всі SHARE_INTERNAL однакові

```
STD = 0
CV = 0
CI = [MEAN, MEAN]

Це нормальний випадок — ідеальна консистентність.
RELIABILITY = HIGH
```

### 7.3. INTERNAL_LIFT = 0 для всіх ринків

```
WEIGHTED_MEAN = undefined (ділення на 0)

Рішення: Використовувати SIMPLE_MEAN
Позначити: "No LIFT data, using simple mean"
```

---

## 8. ФОРМУЛИ SUMMARY

| Метрика | Формула | Примітка |
|---------|---------|----------|
| `WEIGHTED_MEAN` | `Σ(SHARE_i × LIFT_i) / Σ(LIFT_i)` | Основна метрика |
| `SIMPLE_MEAN` | `Σ(SHARE_i) / N` | Для порівняння |
| `STD` | `√(Σ(SHARE_i - MEAN)² / (N-1))` | N ≥ 2 |
| `CV` | `(STD / MEAN) × 100` | % |
| `CI_95_LOWER` | `MEAN - 1.96 × (STD / √N)` | |
| `CI_95_UPPER` | `MEAN + 1.96 × (STD / √N)` | |
| `MIN` | `min(SHARE_i)` | |
| `MAX` | `max(SHARE_i)` | |

---

## 9. ВАЛІДАЦІЯ

### Інваріанти

```python
# WEIGHTED_MEAN в межах [0, 1]
assert 0 <= WEIGHTED_MEAN_SHARE <= 1

# CI логіка
assert CI_95_LOWER <= WEIGHTED_MEAN_SHARE <= CI_95_UPPER

# CI в межах [0, 1] (обрізати якщо виходить)
CI_95_LOWER = max(0, CI_95_LOWER)
CI_95_UPPER = min(1, CI_95_UPPER)

# CV невід'ємний
assert CV_PERCENT >= 0

# MIN <= MEAN <= MAX
assert MIN_SHARE <= WEIGHTED_MEAN_SHARE <= MAX_SHARE
```

---

## 10. НАВІГАЦІЯ

| Ресурс | Посилання |
|--------|-----------|
| Pipeline Phase 2 | [01_PIPELINE_PHASE_2.md](./01_PIPELINE_PHASE_2.md) |
| Бізнес-контекст | [02_SUBSTITUTION_BUSINESS_CONTEXT.md](./02_SUBSTITUTION_BUSINESS_CONTEXT.md) |
| Підготовка даних | [03_DATA_PREPARATION_AND_OUTPUTS.md](./03_DATA_PREPARATION_AND_OUTPUTS.md) |
