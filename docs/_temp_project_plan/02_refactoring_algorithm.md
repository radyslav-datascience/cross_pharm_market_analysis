# Алгоритм рефакторингу скриптів Pipeline

> **Версія:** 1.0 | **Створено:** 31.01.2026

---

## МЕТА

Забезпечити консистентність між:
- Документацією проекту
- Оригінальною реалізацією (research_notebooks)
- Нашою реалізацією (exec_scripts)

---

## АЛГОРИТМ

### Крок 1: Контекст проекту

**Дія:** Переглянути документацію проекту для отримання повного контексту.

**Джерела:**
```
mass_market_analysis_test/docs/
├── 00_ai_rules/          # Бізнес-контекст, правила
├── 01_did_processing/    # Технічна документація Phase 1
├── 02_substitution_coefficients/  # Phase 2
└── _project_history/              # Історія проекту
```

---

### Крок 2: Документація кроку

**Дія:** Детально вивчити документацію конкретного кроку.

**Приклад для Step 1 (Aggregation):**
```
docs/01_did_processing/01_DATA_AGREGATION.md
```

**Що шукаємо:**
- Вхідні/вихідні дані
- Ключові алгоритми
- Критичні моменти (Gap Filling, фільтри)
- Очікувана структура результатів

---

### Крок 3: Оригінальна реалізація

**Дія:** Вивчити як крок реалізований в оригінальному проекті.

**Джерело:**
```
med_prod_research/research_notebooks/
├── 01_nb_aggregation/    # Step 1
├── 02_nb_stockout/       # Step 2
├── 03_nb_did_analysis/   # Step 3
└── ...
```

**Що шукаємо:**
- Послідовність операцій
- Формули та розрахунки
- Обробка edge cases
- Структура вихідних даних

---

### Крок 4: Порівняння реалізацій

**Дія:** Співставити нашу реалізацію з документацією та оригіналом.

**Чекліст:**
- [ ] Всі вхідні колонки присутні
- [ ] Всі вихідні колонки генеруються
- [ ] Алгоритми відповідають документації
- [ ] Формули ідентичні оригіналу
- [ ] Фільтри працюють коректно
- [ ] Edge cases обробляються

---

### Крок 5: Виправлення (з погодженням)

**Дія:** Виявити невідповідності та виправити.

**ВАЖЛИВО:**
1. Спочатку показати знайдені проблеми
2. Отримати згоду на виправлення
3. Тільки потім виправляти

**Типи проблем:**
- Відсутні колонки
- Неправильні формули
- Пропущені фільтри
- Невикористані project_core модулі
- "Костилі" (workarounds)

---

### Крок 5.5: Оновлення документації

**Дія:** Якщо документація неповна або некоректна — оновити.

**Коли оновлювати:**
- Знайдено нові edge cases
- Формули потребують уточнення
- Структура виходу змінилась

---

### Крок 6: Виконання скрипта

**Дія:** Очистити попередні результати та запустити скрипт.

**Послідовність:**
```bash
# 1. Очистити попередні дані
rm -rf data/processed_data/01_per_market/*/01_aggregation_*

# 2. Запустити скрипт
python exec_scripts/02_01_data_aggregation.py --all

# 3. Перевірити створені файли
ls -la data/processed_data/01_per_market/*/01_aggregation_*
```

---

### Крок 7: Верифікація результатів

**Дія:** Порівняти результати з оригінальним проектом.

**Джерело оригінальних результатів:**
```
med_prod_research/data/processed_data/
├── 01_data_aggregation/   # Step 1 results
├── 02_stockout/           # Step 2 results
└── ...
```

**Що порівнювати:**
- Кількість рядків
- Структура колонок
- Вибіркові значення (spot check)
- Агреговані метрики (суми, середні)

---

### Крок 7.5: Документування розбіжностей

**Дія:** Якщо є розбіжності з оригіналом — задокументувати.

**Куди записувати:**
- `docs/_project_history/00_WORK_HISTORY.md`
- Коментарі в коді (якщо це design decision)

**Що документувати:**
- Причина розбіжності
- Чи це баг чи свідоме рішення
- Вплив на подальші кроки

---

### Крок 8: Завершення або повторення

**Якщо верифікація успішна:**
- Позначити крок як завершений
- Переходити до наступного кроку

**Якщо верифікація неуспішна:**
- Повернутися до Кроку 1
- Повторити цикл

---

## ЧЕКЛІСТ ПО КРОКАХ

| Крок Pipeline | Документація | Оригінал | Наш скрипт |
|---------------|--------------|----------|------------|
| Step 0: Preproc | `01_0_PREPROCESSING.md` | — | `01_preproc.py` |
| Step 1: Aggregation | `01_DATA_AGREGATION.md` | `01_nb_aggregation/` | `02_01_data_aggregation.py` |
| Step 2: Stock-out | `02_STOCKOUT_DETECTION.md` | `02_nb_stockout/` | `02_02_stockout_detection.py` |
| Step 3: DiD | `03_DID_NFC_ANALYSIS.md` | `03_nb_did_analysis/` | `02_03_did_analysis.py` |
| Step 4: Substitutes | `04_SUBSTITUTE_SHARE_ANALYSIS.md` | `04_nb_substitute_analysis/` | `02_04_substitute_analysis.py` |
| Step 5: Reports | `05_REPORTS_AND_GRAPHS.md` | `05_nb_reports/` | `02_05_reports_cross_market.py` |

---

## СТАТУС ВИКОНАННЯ

| Крок | Статус | Дата | Примітки |
|------|--------|------|----------|
| Step 0 | DONE | 31.01.2026 | Рефакторинг для project_core |
| Step 1 | AUDITED | 31.01.2026 | Повний аудит: всі формули ідентичні оригіналу (load, convert, parse, gap_fill, NOTSOLD, MARKET_TOTALS). Порядок операцій коректний |
| Step 2 | VERIFIED | 31.01.2026 | Level 1 валідація виправлено, документація оновлена. Результат: 9,645 валідних подій (82.9%) |
| Step 3 | VERIFIED | 31.01.2026 | MARKET_GROWTH виправлено, документація оновлена. Результат: 8,216 DiD подій (85.2%), AVG SHARE_INTERNAL 52.6% |
| Step 4 | VERIFIED | 31.01.2026 | Формули ідентичні. Виправлено INN_ID/INN_NAME. Результат: 8,287 пар, AVG SAME_NFC1 77.9%, валідація SHARE=100% OK |
| Step 5 | VERIFIED | 31.01.2026 | AGG_SHARE виправлено на ratio сум (weighted avg). Результат: 773 drugs, 8,287 substitute pairs, 5 markets. Валідація SHARE=100% OK |
