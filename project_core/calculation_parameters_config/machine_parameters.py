# =============================================================================
# MACHINE PARAMETERS CONFIG - cross_pharm_market_analysis
# =============================================================================
# Файл: project_core/calculation_parameters_config/machine_parameters.py
# Дата: 2026-02-12
# Опис: Параметри обчислювальної машини для оптимізації розрахунків пайплайну
# =============================================================================
"""
Конфігуратор параметрів обчислювальної машини.

ІНСТРУКЦІЯ ДЛЯ НОВОГО ВИКОНАВЦЯ:
    При виконанні розрахунків на іншій машині змініть значення нижче
    відповідно до характеристик вашого обладнання.

    Документація: docs/_project_tech_parameters/_computing_machine_parameters.md

Поточна машина:
    MacBook Pro, 2.6 GHz 6-Core Intel Core i7, 16 GB DDR4, SSD
"""


# =============================================================================
# CPU PARAMETERS
# =============================================================================

# Кількість фізичних ядер процесора
# (Intel i7-9750H: 6 фізичних ядер, 12 логічних з Hyper-Threading)
# Де перевірити: macOS → About This Mac → Processor
# Або в терміналі: sysctl -n hw.physicalcpu
CPU_PHYSICAL_CORES = 6

# Кількість логічних ядер (з урахуванням Hyper-Threading)
# Або в терміналі: sysctl -n hw.logicalcpu
CPU_LOGICAL_CORES = 12


# =============================================================================
# MEMORY PARAMETERS
# =============================================================================

# Загальний обсяг оперативної пам'яті (ГБ)
# Де перевірити: macOS → About This Mac → Memory
TOTAL_RAM_GB = 16

# Максимальний обсяг RAM, який можна використовувати для обчислень (ГБ)
# Рекомендація: TOTAL_RAM_GB - 4 ГБ (залишаємо для ОС та інших процесів)
AVAILABLE_RAM_GB = 12

# Очікуваний пік пам'яті на один worker-процес (ГБ)
# Залежить від розміру найбільшого ринку та складності обчислень
# Для типового ринку: 300–500 МБ, для великого: до 800 МБ
RAM_PER_WORKER_GB = 0.5


# =============================================================================
# PARALLEL PROCESSING PARAMETERS
# =============================================================================

# Максимальна кількість паралельних worker-процесів
# Формула: min(CPU_PHYSICAL_CORES - 1, AVAILABLE_RAM_GB // RAM_PER_WORKER_GB)
# Для поточної машини: min(5, 24) = 5
# УВАГА: значення > CPU_PHYSICAL_CORES не дає приросту і може сповільнити
MAX_WORKERS = 5

# Мінімальна кількість workers (fallback якщо auto-detection не спрацює)
MIN_WORKERS = 1

# Таймаут на обробку одного ринку (секунди)
# Якщо обробка ринку перевищує цей час — worker буде зупинений
# 600 сек = 10 хв — достатньо навіть для найбільших ринків після оптимізації
MARKET_TIMEOUT_SEC = 600

# Чи показувати прогрес-бар при паралельних обчисленнях
SHOW_PROGRESS = True


# =============================================================================
# INTRA-MARKET PARALLELISM (INN-рівневий паралелізм)
# =============================================================================

# Кількість потоків для INN-рівневого паралелізму всередині одного market worker.
# Кожен worker-процес (inter-market) може запускати threads для обробки INN-груп.
# ThreadPoolExecutor використовується тому що pandas звільняє GIL при C-операціях.
#
# Формула: min(4, max(1, CPU_LOGICAL_CORES // MAX_WORKERS))
# Для поточної машини: min(4, 12 // 5) = 2
#
# Загальний ліміт активних потоків: MAX_WORKERS × THREADS_PER_WORKER
# Для поточної машини: 5 × 2 = 10 (менше 12 logical cores — ок)
#
# УВАГА: Якщо INN-груп менше ніж THREADS_PER_WORKER, зайві потоки не створюються.
# Значення 1 = відключити INN-паралелізм (послідовна обробка як раніше).
THREADS_PER_WORKER = 2


# =============================================================================
# DISK PARAMETERS
# =============================================================================

# Тип диска (для інформації; не впливає на логіку)
# Можливі значення: 'SSD', 'HDD', 'NVMe'
DISK_TYPE = 'SSD'


# =============================================================================
# DERIVED PARAMETERS (обчислюються автоматично, НЕ змінювати вручну)
# =============================================================================

def get_optimal_workers() -> int:
    """
    Розрахувати оптимальну кількість workers на основі параметрів машини.

    Враховує:
        - Кількість фізичних ядер (залишаємо 1 для системи)
        - Доступну RAM (ділимо на пік пам'яті per worker)
        - Не менше MIN_WORKERS, не більше MAX_WORKERS

    Returns:
        int: Оптимальна кількість workers
    """
    cpu_based = max(1, CPU_PHYSICAL_CORES - 1)
    ram_based = max(1, int(AVAILABLE_RAM_GB / RAM_PER_WORKER_GB))

    optimal = min(cpu_based, ram_based, MAX_WORKERS)
    optimal = max(optimal, MIN_WORKERS)

    return optimal


# Кількість workers для використання в пайплайні
OPTIMAL_WORKERS = get_optimal_workers()


def get_optimal_threads() -> int:
    """
    Розрахувати оптимальну кількість INN-потоків per worker.

    Враховує:
        - Кількість логічних ядер (ділимо на кількість workers)
        - Не більше 4 (diminishing returns)
        - Не менше 1 (мінімальний fallback)
        - Не більше THREADS_PER_WORKER (ліміт конфігурації)

    Returns:
        int: Оптимальна кількість потоків per worker
    """
    cpu_based = max(1, CPU_LOGICAL_CORES // max(1, OPTIMAL_WORKERS))
    optimal = min(cpu_based, 4, THREADS_PER_WORKER)
    return max(1, optimal)


# Кількість INN-потоків per worker
OPTIMAL_THREADS = get_optimal_threads()
